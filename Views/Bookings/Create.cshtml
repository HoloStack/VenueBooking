@model Booking
@{
    ViewData["Title"] = "Create Booking";
}

@section Styles {
    <link rel="stylesheet" href="~/css/universal.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
}

<div class="container">
    <div class="form-container">
        <div class="form-header">
            <h1><i class="fas fa-ticket-alt me-3"></i>Create New Booking</h1>
            <p>Reserve a spot for your customer at an upcoming event</p>
        </div>
        
        <div class="form-body">
            @if (!string.IsNullOrEmpty(ViewBag.PreSelectedEvent))
            {
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Event Pre-selected:</strong> @ViewBag.PreSelectedEvent 
                    @if (!string.IsNullOrEmpty(ViewBag.PreSelectedEventDate))
                    {
                        <span>on @ViewBag.PreSelectedEventDate at @ViewBag.PreSelectedVenue</span>
                    }
                </div>
            }

            <!-- Event Date Display -->
            <div id="eventDateDisplay" class="alert alert-success" style="display: none;">
                <i class="fas fa-calendar-check me-2"></i>
                <strong>Event Date:</strong> <span id="eventDateText"></span>
            </div>
            
            <form asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-map-marker-alt me-2"></i>Event Selection</h5>
                    
                    <div class="mb-3">
                        <label asp-for="VenueId" class="form-label">
                            <i class="fas fa-building"></i>
                            Venue Location
                        </label>
                        <select asp-for="VenueId" class="form-select" asp-items="ViewBag.Venues">
                            <option value="">-- Select Venue --</option>
                        </select>
                        <span asp-validation-for="VenueId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="EventId" class="form-label">
                            <i class="fas fa-calendar-alt"></i>
                            Event Selection
                        </label>
                        <div class="mb-3">
                            <div class="form-check form-check-inline p-2 border rounded me-3">
                                <input class="form-check-input" type="radio" name="eventSelectionMode" id="venueFiltered" value="venue" checked>
                                <label class="form-check-label fw-semibold" for="venueFiltered">
                                    <i class="fas fa-filter me-1"></i>
                                    Show events for selected venue
                                </label>
                            </div>
                            <div class="form-check form-check-inline p-2 border rounded">
                                <input class="form-check-input" type="radio" name="eventSelectionMode" id="allEvents" value="all">
                                <label class="form-check-label fw-semibold" for="allEvents">
                                    <i class="fas fa-list me-1"></i>
                                    Show all events
                                </label>
                            </div>
                        </div>
        
                        <!-- Venue-filtered events dropdown -->
                        <select id="venueFilteredEvents" name="EventIdFiltered" class="form-select" disabled>
                            <option value="">-- Select Event --</option>
                        </select>
                        
                        <!-- All events dropdown -->
                        <select id="allEventsDropdown" name="EventIdTemp" class="form-select" asp-items="ViewBag.AllEvents" style="display: none;">
                            <option value="">-- Select Event --</option>
                        </select>
                        
                        <!-- Hidden field to store the actual EventId -->
                        <input type="hidden" asp-for="EventId" id="hiddenEventId" />
                        
                        <span asp-validation-for="EventId" class="text-danger"></span>
                        <div class="form-text">
                            <small id="venueFilteredHelp">
                                <i class="fas fa-info-circle me-1"></i>
                                Select a venue first to see available events
                            </small>
                            <small id="allEventsHelp" style="display: none;">
                                <i class="fas fa-info-circle me-1"></i>
                                Choose any event - venue will be auto-selected
                            </small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-user me-2"></i>Customer Information</h5>
                    
                    <div class="mb-3">
                        <label asp-for="CustomerName" class="form-label">
                            <i class="fas fa-user"></i>
                            Customer Name
                        </label>
                        <input asp-for="CustomerName" class="form-control" placeholder="Enter full customer name" />
                        <span asp-validation-for="CustomerName" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-section">
                    <h5 class="section-title"><i class="fas fa-calendar-day me-2"></i>Booking Details</h5>
                    
                    <div class="mb-3">
                        <label asp-for="BookingDate" class="form-label">
                            <i class="fas fa-calendar-day"></i>
                            Booking Date
                        </label>
                        <input asp-for="BookingDate" type="date" class="form-control" readonly style="background-color: #f8f9fa;" />
                        <span asp-validation-for="BookingDate" class="text-danger"></span>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Date will be set automatically based on selected event
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-form-primary">
                        <i class="fas fa-check me-2"></i>Create Booking
                    </button>
                    <a asp-action="Index" class="btn-form-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script type="text/javascript">
        $(document).ready(function() {
            var venueSelect = $('#VenueId');
            var venueFilteredEvents = $('#venueFilteredEvents');
            var allEventsDropdown = $('#allEventsDropdown');
            var bookingDateInput = $('#BookingDate');
            var eventDateDisplay = $('#eventDateDisplay');
            var eventDateText = $('#eventDateText');
            var venueFilteredHelp = $('#venueFilteredHelp');
            var allEventsHelp = $('#allEventsHelp');
            
            var currentEventSelect = venueFilteredEvents; // Track which dropdown is active
            
            // Toggle between event selection modes
            $('input[name="eventSelectionMode"]').on('change', function() {
                if ($(this).val() === 'venue') {
                    // Show venue-filtered mode
                    venueFilteredEvents.show();
                    allEventsDropdown.hide();
                    venueFilteredHelp.show();
                    allEventsHelp.hide();
                    currentEventSelect = venueFilteredEvents;
                    
                    // Clear all events selection
                    allEventsDropdown.val('');
                } else {
                    // Show all events mode
                    venueFilteredEvents.hide();
                    allEventsDropdown.show();
                    venueFilteredHelp.hide();
                    allEventsHelp.show();
                    currentEventSelect = allEventsDropdown;
                    
                    // Clear venue-filtered selection
                    venueFilteredEvents.val('');
                }
                
                // Clear date display
                bookingDateInput.val('');
                eventDateDisplay.hide();
            });
            
            // When venue is selected, load events for that venue (only in venue-filtered mode)
            venueSelect.on('change', function() {
                var venueId = $(this).val();
                
                // Only update if in venue-filtered mode
                if ($('#venueFiltered').is(':checked')) {
                    // Clear event selection and hide date display
                    venueFilteredEvents.empty();
                    venueFilteredEvents.append('<option value="">-- Select Event --</option>');
                    bookingDateInput.val('');
                    eventDateDisplay.hide();
                    
                    if (venueId) {
                        // Enable event dropdown and load events
                        venueFilteredEvents.prop('disabled', false);
                        
                        $.get('/Bookings/GetEventsForVenue', { venueId: venueId })
                            .done(function(data) {
                                if (data && data.length > 0) {
                                    $.each(data, function(i, event) {
                                        venueFilteredEvents.append('<option value="' + event.value + '">' + event.text + ' (' + event.date + ')</option>');
                                    });
                                } else {
                                    venueFilteredEvents.append('<option value="">No events available for this venue</option>');
                                }
                            })
                            .fail(function() {
                                venueFilteredEvents.append('<option value="">Error loading events</option>');
                            });
                    } else {
                        // Disable event dropdown if no venue selected
                        venueFilteredEvents.prop('disabled', true);
                    }
                }
            });
            
            // Handle event selection from both dropdowns
            function handleEventSelection(eventId) {
                if (eventId) {
                    // Get event details
                    $.get('/Bookings/GetEventDetails', { eventId: eventId })
                        .done(function(data) {
                            if (data) {
                                // Auto-select venue if not already selected
                                if (venueSelect.val() != data.venueId) {
                                    venueSelect.val(data.venueId);
                                }
                                
                                // Set booking date to event date
                                bookingDateInput.val(data.dateOnly);
                                
                                // Show event date display
                                eventDateText.text(data.eventDate + ' at ' + data.venueName);
                                eventDateDisplay.show();
                            }
                        })
                        .fail(function() {
                            console.error('Error loading event details');
                        });
                } else {
                    // Clear date and hide display if no event selected
                    bookingDateInput.val('');
                    eventDateDisplay.hide();
                }
            }
            
            // Bind event selection handlers
            venueFilteredEvents.on('change', function() {
                var eventId = $(this).val();
                $('#hiddenEventId').val(eventId);
                handleEventSelection(eventId);
            });
            
            allEventsDropdown.on('change', function() {
                var eventId = $(this).val();
                $('#hiddenEventId').val(eventId);
                handleEventSelection(eventId);
            });
            
            // Initially disable venue-filtered event dropdown
            venueFilteredEvents.prop('disabled', true);
        });
    </script>
}
